# ==============================================================================
# MATHARE SIMPLE TREE - CLEAN AND WORKING VERSION (CORRECTED)
# ==============================================================================
# Load required libraries
library(readxl)
library(collapsibleTree)
library(dplyr)
library(htmlwidgets)
library(htmltools)

# Read the Excel data
# mathare <- read_excel("mathare_1.xlsx")

# ==============================================================================
# CORRECTED DATA STRUCTURE - ALL BRANCHES INCLUDED
# ==============================================================================
# Create complete cascade data with all branches (13 rows total)
mathare_simple <- data.frame(
  Level1 = rep("Workload: 2416", 13),
  
  Level2 = c(
    # Screened branch (12 rows)
    rep("Screened: 2325(96%)", 12),
    # Not screened branch (1 row)
    "Not screened: 91(4%)"
  ),
  
  Level3 = c(
    # With R. conditions (11 rows)
    rep("With R.Conditions: 298(13%)", 11),
    # No R. conditions (1 row)
    "No R.Conditions: 2027(87%)",
    # Not screened - no assessment (1 row)
    NA
  ),
  
  Level4 = c(
    # CXR for those with R.conditions (11 rows)
    rep("CXR Done: 298(100%)", 11),
    # No CXR needed for no R.conditions (1 row)
    NA,
    # No CXR for not screened (1 row)
    NA
  ),
  
  Level5 = c(
    # CXR results breakdown (11 rows)
    rep("TB Suggestive: 78", 2),
    rep("Other Abnormal: 68", 7),
    "Lung Nodules: 2",
    "Normal: 150",
    # No further breakdown for other branches (2 rows)
    NA,
    NA
  ),
  
  Level6 = c(
    # Further investigations (11 rows)
    "TB investigation: 76(97%)",
    "TB investigation: 76(97%)", 
    rep("Spirometer done: 68", 7),
    NA,
    NA,
    # No investigations for other branches (2 rows)
    NA,
    NA
  ),
  
  Level7 = c(
    # Investigation results (11 rows)
    "MTB Pos: 10(13.1%)",
    "MTB Neg: 66",
    "Normal: 21(31%)",
    "Restrictive: 18(26%)",
    rep("Obstructive: 27(40%)", 4),
    "Mixed: 2(3%)",
    NA,
    NA,
    # No results for other branches (2 rows)
    NA,
    NA
  ),
  
  Level8 = c(
    # Final diagnoses/treatments (11 rows)
    NA,
    "CD:4", 
    NA,
    NA,
    "Asthma: 13",
    "COPD: 4",
    "PTLD: 5",
    "Other: 5",
    NA,
    NA,
    NA,
    # No treatments for other branches (2 rows)
    NA,
    NA
  ),
  
  stringsAsFactors = FALSE
)

# ==============================================================================
# SIMPLE COLLAPSIBLE TREE
# ==============================================================================
# Create simple tree
simple_tree <- collapsibleTree(
  mathare_simple,
  hierarchy = c("Level1", "Level2", "Level3", "Level4", "Level5", "Level6", "Level7", "Level8"),
  root = "Mathare Cascade",
  width = 1400,
  height = 800,
  fontSize = 16,
  fontFamily = "Arial, sans-serif",
  zoomable = TRUE,
  tooltip = TRUE
)

# Add a clean title
titled_tree <- simple_tree %>%
  htmlwidgets::prependContent(
    htmltools::tags$div(
      style = "text-align: center; margin-bottom: 15px; padding: 12px; background: #3498db; color: white; border-radius: 6px;",
      htmltools::h2(
        "Mathare North Health Center - Lung Health Screening & Diagnosis Cascade",
        style = "margin: 0; font-size: 30px; font-weight: bold; font-family: Arial, sans-serif;"
      )
    )
  )

# Display the tree with title
titled_tree

# ==============================================================================
# SAVE THE CORRECTED VERSION
# ==============================================================================
# Save corrected version  
htmlwidgets::saveWidget(
  titled_tree,
  "mathare_complete_tree.html", 
  selfcontained = TRUE,
  title = "Mathare Complete Cascade"
)

cat("Complete tree created successfully!\n")
cat("Features:\n")
cat("✓ Clean, short labels\n")
cat("✓ 8 levels of hierarchy\n") 
cat("✓ All branches included:\n")
cat("  - Screened vs Not screened\n")
cat("  - With R.Conditions vs No R.Conditions\n")
cat("  - Complete diagnostic pathway\n")
cat("✓ Zoom and tooltip enabled\n")
cat("✓ All data vectors have equal length (13 rows)\n")
cat("Saved as: mathare_complete_tree.html\n")

# ==============================================================================
# VERIFICATION - Check data structure
# ==============================================================================
cat("\nData structure verification:\n")
cat("Number of rows in each column:\n")
for(col in names(mathare_simple)) {
  cat(paste(col, ":", length(mathare_simple[[col]]), "rows\n"))
}

# ==============================================================================
# SUMMARY OF PATIENT FLOW
# ==============================================================================
cat("\nPatient Flow Summary:\n")
cat("Total Workload: 2,416 patients\n")
cat("├── Screened: 2,325 (96%)\n")
cat("│   ├── With R.Conditions: 298 (13%)\n")
cat("│   │   └── [Complete diagnostic cascade]\n")
cat("│   └── No R.Conditions: 2,027 (87%)\n")
cat("└── Not Screened: 91 (4%)\n")